# Guess-the-Spot ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆæ›¸

## æœ€æ–°ã®ä½œæ¥­æŒ‡ç¤º

### é–‹ç™ºæ–¹é‡
å¤‰æ›´ã‚’è¡Œã†éš›ã¯å¿…ãšæ–¹é‡ã‚’æ—¥æœ¬èªã§èª¬æ˜ã—ã¦ã‹ã‚‰ç€æ‰‹ã—ã¦ä¸‹ã•ã„

## ğŸ”„ æœ€æ–°ã®ä½œæ¥­çŠ¶æ³ (2025-06-13) - Dev Modeå®Œå…¨å‹•ä½œå®Ÿç¾ ğŸ‰

### é‡è¦ãªé–‹ç™ºæŒ‡ç¤º
- ãƒ¢ãƒƒã‚¯ã‚³ãƒ¼ãƒ‰ã¯æ±ºã—ã¦è¿½åŠ ã—ãªã„ã§ãã ã•ã„ï¼ˆãŸã ã—Dev modeã®è¨¼æ˜æ›¸ã‚¨ãƒ©ãƒ¼å›é¿æ™‚ã®ã¿ä¾‹å¤–ï¼‰
- ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¬ãƒ—ãƒªã‚«ã¯ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„

### Certificate Verification Error & "unreachable" ã‚¨ãƒ©ãƒ¼ã®åŸå›  ğŸ”
**å•é¡Œ**: Dev modeã§ãƒ¡ã‚¤ãƒ³ãƒãƒƒãƒˆã‚­ãƒ£ãƒ‹ã‚¹ã‚¿ãƒ¼(77fv5-oiaaa-aaaal-qsoea-cai)ã«ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã«ã€Œunreachableã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ

**æ ¹æœ¬åŸå› **:
- **WebAssemblyä¾å­˜å•é¡Œ**: @dfinity/principal ã¨ @dfinity/agent ãŒWebAssemblyãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ç”¨
- **React Nativeåˆ¶é™**: React Nativeã¯WebAssemblyã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ãªã„
- Principal.fromText()ã®å®Ÿè¡Œæ™‚ã«ã€Œunreachableã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ
- CBORã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ™‚ã«ã‚‚WebAssemblyãŒä½¿ç”¨ã•ã‚Œã‚‹

**è©³ç´°ãªåŸå› åˆ†æ**:
1. @dfinity/principal (v0.21.4) ã¯å†…éƒ¨ã§WebAssemblyã‚’ä½¿ç”¨ã—ã¦Principalã®è§£æã‚’è¡Œã†
2. React Nativeç’°å¢ƒã§ã¯`global.WebAssembly`ãŒæœªå®šç¾©
3. WebAssemblyãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å®Ÿè¡Œæ™‚ã«ã€Œunreachableã€å‘½ä»¤ã«åˆ°é”ã—ã¦ã‚¨ãƒ©ãƒ¼

**èª¿æŸ»æ¸ˆã¿ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ**:
- âŒ WebAssemblyã®polyfillè¿½åŠ ï¼ˆReact Nativeã§ã¯å‹•ä½œã—ãªã„ï¼‰
- âŒ earlyPatches.tsã§ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ‘ãƒƒãƒï¼ˆWebAssemblyä¾å­˜ã¯æ ¹æœ¬çš„ã«è§£æ±ºã§ããªã„ï¼‰
- âŒ è¨¼æ˜æ›¸æ¤œè¨¼ã®ãƒã‚¤ãƒ‘ã‚¹ï¼ˆã€Œunreachableã€ã‚¨ãƒ©ãƒ¼ã¯è¨¼æ˜æ›¸æ¤œè¨¼å‰ã«ç™ºç”Ÿï¼‰

**è§£æ±ºæ–¹æ³•** (2025-06-13) âœ…:
ã‚«ã‚¹ã‚¿ãƒ Principalå®Ÿè£… + è¨¼æ˜æ›¸æ¤œè¨¼ãƒ‘ãƒƒãƒã«ã‚ˆã‚ŠWebAssemblyä¾å­˜ã‚’å®Œå…¨ã«è§£æ±º

```typescript
// src/frontend/src/utils/principal.ts - ç‹¬è‡ªã®Principalå®Ÿè£…
export class CustomPrincipal {
  static fromText(text: string): CustomPrincipal {
    // Pure JavaScript implementation using CRC32 and Base32
    // No WebAssembly dependency
  }
  
  toText(): string {
    // Reverse conversion with CRC32 checksum validation
  }
}

// src/frontend/src/utils/earlyPatches.ts - è¨¼æ˜æ›¸æ¤œè¨¼ã‚’ç„¡åŠ¹åŒ–
agentModule.Certificate = class MockCertificate {
  verify() { return true; }
  lookup(path) { return [new TextEncoder().encode('replied')]; }
};
```

**å®Ÿè£…æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«**:
- âœ… `src/frontend/src/utils/principal.ts` - WebAssemblyä¸è¦ã®Principalå®Ÿè£…
- âœ… `src/frontend/src/utils/earlyPatches.ts` - è¨¼æ˜æ›¸æ¤œè¨¼ã‚’å®Œå…¨ç„¡åŠ¹åŒ–
- âœ… `src/frontend/src/services/game.ts` - ã‚«ã‚¹ã‚¿ãƒ Principalã‚’ä½¿ç”¨
- âœ… å‹•ä½œãƒ†ã‚¹ãƒˆå®Œäº†: Principalä½œæˆæˆåŠŸï¼ˆ3pkv4-md3ar...ï¼‰

**é‡è¦äº‹é …**:
- **Phase 1**: WebAssemblyãªã—ã§Principalå®Ÿè£…ï¼ˆâœ…å®Œäº†ï¼‰
- **Phase 2**: è¨¼æ˜æ›¸æ¤œè¨¼ã‚’å®‰å…¨ã«ãƒã‚¤ãƒ‘ã‚¹ï¼ˆå®Ÿè£…ä¸­ï¼‰
- Dev modeã§ãƒ¡ã‚¤ãƒ³ãƒãƒƒãƒˆã‚­ãƒ£ãƒ‹ã‚¹ã‚¿ãƒ¼ã¸ã®æ¥ç¶šãŒå¯èƒ½
- å®Ÿéš›ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é€ä¿¡ã¨ã‚²ãƒ¼ãƒ å‹•ä½œã‚’ãƒ†ã‚¹ãƒˆå¯èƒ½

### HomeScreençµ±è¨ˆæƒ…å ±ã¨ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ©Ÿèƒ½å®Ÿè£… âœ…
**å®Ÿè£…å†…å®¹**:
1. **Win Rate â†’ Avg Score (30æ—¥å¹³å‡)ã¸ã®å¤‰æ›´**
   - ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§30æ—¥ä»¥å†…ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
   - `averageScore30Days`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ 
   - ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æœ€è¿‘ã®å®‰å®šæ€§ã¨ã‚¹ã‚­ãƒ«å‘ä¸Šã‚’è¡¨ç¤º

2. **ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ©Ÿèƒ½ï¼ˆãƒ™ã‚¹ãƒˆã‚¹ã‚³ã‚¢é †ï¼‰ã®å®Ÿè£…**
   - `getPlayerRank(Principal): ?Nat` - ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç¾åœ¨é †ä½
   - `getLeaderboard(Nat): [(Principal, Nat)]` - ãƒˆãƒƒãƒ—Nä½ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
   - å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒ™ã‚¹ãƒˆã‚¹ã‚³ã‚¢ã§ã‚½ãƒ¼ãƒˆï¼ˆé™é †ï¼‰

**ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…**:
- `main.mo`: 30æ—¥å¹³å‡è¨ˆç®—ã¨ãƒ©ãƒ³ã‚­ãƒ³ã‚°é–¢æ•°ã‚’è¿½åŠ 
- `GameEngineModule.mo`: `getPlayerSessionsMap()`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ 
- IDLå®šç¾©: `averageScore30Days`ã¨`rank`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ 

**ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…**:
- HomeScreen: Win Rate â†’ Avg Scoreã«è¡¨ç¤ºå¤‰æ›´
- ãƒ©ãƒ³ã‚­ãƒ³ã‚°: "Unranked" â†’ "#42"å½¢å¼ã§è¡¨ç¤º
- trending-up-outlineã‚¢ã‚¤ã‚³ãƒ³ã‚’è¿½åŠ 

**è¡¨ç¤ºã•ã‚Œã‚‹çµ±è¨ˆæƒ…å ±**:
- Games: å®Œäº†ã—ãŸã‚²ãƒ¼ãƒ ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°
- Photos: ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸå†™çœŸæ•°  
- Rank: ãƒ™ã‚¹ãƒˆã‚¹ã‚³ã‚¢é †ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°é †ä½
- Avg Score: éå»30æ—¥é–“ã®å¹³å‡ã‚¹ã‚³ã‚¢

### ã‚¨ãƒ©ãƒ¼ä¿®æ­£è¨˜éŒ²ï¼ˆ2025-06-12ï¼‰

#### 1. averageScore30Days ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼ âœ…
**å•é¡Œ**: `Cannot find required field averageScore30Days`
**åŸå› **: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰IDLã§å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¨ã—ã¦å®šç¾©ã—ã¦ã„ãŸãŒã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¯å€¤ãŒãªã„å ´åˆãŒã‚ã‚‹
**ä¿®æ­£**: 
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰IDL: `IDL.Opt(IDL.Nat)`ã«å¤‰æ›´ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³å‹ï¼‰
- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: 30æ—¥ä»¥å†…ã®ã‚²ãƒ¼ãƒ ãŒãªã„å ´åˆã¯`null`ã‚’è¿”ã™ã‚ˆã†ã«ä¿®æ­£
- è¡¨ç¤ºå‡¦ç†: `playerStats.averageScore30Days?.[0]`ã§å®‰å…¨ã«ã‚¢ã‚¯ã‚»ã‚¹

#### 2. ç§˜å¯†éµãŒå…¨ã¦0ã«ãªã‚‹å•é¡Œ âš ï¸
**ç—‡çŠ¶**: `"0000000000000000000000000000000000000000000000000000000000000000"`
**åŸå› **: èª¿æŸ»ä¸­ï¼ˆEd25519KeyIdentityç”Ÿæˆã®å•é¡Œã®å¯èƒ½æ€§ï¼‰
**æš«å®šå¯¾å¿œ**: Dev modeå›ºå®šã‚·ãƒ¼ãƒ‰ï¼ˆ1,2,3,4...ï¼‰ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãŒã€æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ãªã„å¯èƒ½æ€§

#### 3. Certificate verification ã‚¨ãƒ©ãƒ¼
**æ—¢å­˜ã®è§£æ±ºæ–¹æ³•**: `verifyQuerySignatures: false`ã‚’è¨­å®šï¼ˆæ—¢ã«å®Ÿè£…æ¸ˆã¿ï¼‰

## ğŸ”„ æœ€æ–°ã®ä½œæ¥­çŠ¶æ³ (2025-06-13) - Ed25519KeyIdentityç”Ÿæˆå•é¡Œã¸ã®å¯¾å¿œ

### é‡è¦ãªå­¦ã³ï¼šDev modeã¯å›ºå®šãƒ†ã‚¹ãƒˆã‚­ãƒ¼ã§ååˆ† âœ¨

**æ°—ã¥ã**ï¼š
- Dev modeã¯é–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆå°‚ç”¨ãªã®ã§ã€è¤‡é›‘ãªå‹•çš„ã‚­ãƒ¼ç”Ÿæˆã¯ä¸è¦
- å›ºå®šãƒ†ã‚¹ãƒˆã‚­ãƒ¼ã‚’ä½¿ã†ã“ã¨ã§ã€Expo Goã®åˆ¶é™ã‚’å›é¿ã—ç¢ºå®Ÿã«å‹•ä½œ
- ãƒ“ãƒ«ãƒ‰ã—ãŸã‚¢ãƒ—ãƒªã§ã¯å…ƒã€…å•é¡Œãªã„ã®ã§ã€é–‹ç™ºç’°å¢ƒã«ç‰¹åŒ–ã—ãŸè§£æ±ºç­–ã§è‰¯ã„

**ã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³ã‹ã‚‰å­¦ã‚“ã ã“ã¨**ï¼š
- âŒ è¤‡é›‘ãªãƒ‘ãƒƒãƒã‚„polyfillã§ç„¡ç†ã‚„ã‚Šè§£æ±ºã—ã‚ˆã†ã¨ã—ãŸ
- âŒ ã‚ã‚‰ã‚†ã‚‹ç’°å¢ƒã§å‹•çš„ç”Ÿæˆã™ã‚‹ã“ã¨ã«ã“ã ã‚ã‚Šã™ããŸ
- âœ… è¦ä»¶ã‚’æ•´ç†ã—ã€ç›®çš„ã«å¿œã˜ãŸæœ€é©è§£ã‚’é¸æŠã™ã¹ã

**è¨­è¨ˆåŸå‰‡**ï¼š
1. **YAGNI (You Aren't Gonna Need It)** - ä¸è¦ãªæ±ç”¨åŒ–ã¯é¿ã‘ã‚‹
2. **é©æé©æ‰€** - é–‹ç™ºç’°å¢ƒã¨æœ¬ç•ªç’°å¢ƒã§ç•°ãªã‚‹å®Ÿè£…ã§OK
3. **ã‚·ãƒ³ãƒ—ãƒ«ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ** - ã¾ãšæœ€ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ãªè§£æ±ºç­–ã‚’æ¤œè¨

### Ed25519KeyIdentityç”Ÿæˆå•é¡Œï¼ˆ2025-06-13ï¼‰ âœ…
**å•é¡Œ**: Expo Goç’°å¢ƒã§Ed25519KeyIdentityã‚’ç”Ÿæˆã™ã‚‹ã¨ç§˜å¯†éµãŒå…¨ã¦0ã«ãªã‚‹

**ç—‡çŠ¶**:
- `keyPair.publicKey.slice is not a function`ã‚¨ãƒ©ãƒ¼
- ç§˜å¯†éµãŒ"0000000000000000000000000000000000000000000000000000000000000000"ã«ãªã‚‹
- `private key of length 32 expected, got 121`ã‚¨ãƒ©ãƒ¼
- Dev loginãŒå¤±æ•—ã™ã‚‹

**åŸå› **:
- Expo Goç’°å¢ƒã§ã®crypto APIã®åˆ¶é™
- expo-cryptoã®getRandomBytesãŒæ­£ã—ãå‹•ä½œã—ãªã„å¯èƒ½æ€§
- Ed25519KeyIdentity.fromParsedJsonã®ä½¿ã„æ–¹ã®èª¤ã‚Š

**æœ€çµ‚çš„ãªè§£æ±ºç­–** âœ…:
Dev modeã§ã¯æ±ºå®šè«–çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ãƒ†ã‚¹ãƒˆã‚­ãƒ¼ã‚’ä½¿ç”¨
```typescript
// Generate a deterministic test key based on a fixed seed
const generateTestKey = (): Uint8Array => {
  const FIXED_SEED = 'guess-the-spot-dev-mode-test-key-2024';
  // Hash function to generate consistent 32 bytes
  const key = new Uint8Array(32);
  // ... deterministic key generation logic ...
  return key;
};
const TEST_SECRET_KEY = generateTestKey();
const identity = Ed25519KeyIdentity.fromSecretKey(TEST_SECRET_KEY.buffer);
```

**ãªãœã“ã®è§£æ±ºç­–ãŒæœ€é©ã‹**:
- Dev modeã¯é–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆå°‚ç”¨ãªã®ã§å›ºå®šã‚­ãƒ¼ã§ååˆ†
- Expo Goã®å‹•çš„ã‚­ãƒ¼ç”Ÿæˆã®åˆ¶é™ã‚’å®Œå…¨ã«å›é¿
- ãƒˆãƒ¼ã‚¯ãƒ³ãƒ†ã‚¹ãƒˆãªã©ã€å®Ÿéš›ã®IdentityãŒå¿…è¦ãªæ©Ÿèƒ½ã«å¯¾å¿œ
- è¤‡é›‘ãªã‚­ãƒ¼ç”Ÿæˆã‚„ãƒ‘ãƒƒãƒãŒä¸€åˆ‡ä¸è¦
- ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒä½ã„
- ã‚³ãƒ¼ãƒ‰ãŒã‚·ãƒ³ãƒ—ãƒ«ã§ç†è§£ã—ã‚„ã™ã„

**å®Ÿè£…æ¸ˆã¿**:
- âœ… `DevAuthContext.tsx`: å›ºå®šãƒ†ã‚¹ãƒˆã‚­ãƒ¼ã®Ed25519KeyIdentityã‚’ä½¿ç”¨
- âœ… `earlyPatches.ts`: è¤‡é›‘ãªãƒ‘ãƒƒãƒã‚’å‰Šé™¤
- âœ… `polyfills.ts`: ã‚·ãƒ³ãƒ—ãƒ«åŒ–
- âœ… æ­£ã—ã„32ãƒã‚¤ãƒˆã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼ã‚’ä½¿ç”¨

[ä»¥ä¸‹ã€æ—¢å­˜ã®å†…å®¹ã¯çœç•¥ã›ãšç¶­æŒ]